var k=Object.create;var U=Object.defineProperty;var ee=Object.getOwnPropertyDescriptor;var te=Object.getOwnPropertyNames;var re=Object.getPrototypeOf,ne=Object.prototype.hasOwnProperty;var ie=(e,r)=>()=>(r||e((r={exports:{}}).exports,r),r.exports);var ae=(e,r,t,i)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of te(r))!ne.call(e,s)&&s!==t&&U(e,s,{get:()=>r[s],enumerable:!(i=ee(r,s))||i.enumerable});return e};var oe=(e,r,t)=>(t=e!=null?k(re(e)):{},ae(r||!e||!e.__esModule?U(t,"default",{value:e,enumerable:!0}):t,e));var B=ie(x=>{"use strict";Object.defineProperty(x,"__esModule",{value:!0});x.pathToRegexp=x.tokensToRegexp=x.regexpToFunction=x.match=x.tokensToFunction=x.compile=x.parse=void 0;function pe(e){for(var r=[],t=0;t<e.length;){var i=e[t];if(i==="*"||i==="+"||i==="?"){r.push({type:"MODIFIER",index:t,value:e[t++]});continue}if(i==="\\"){r.push({type:"ESCAPED_CHAR",index:t++,value:e[t++]});continue}if(i==="{"){r.push({type:"OPEN",index:t,value:e[t++]});continue}if(i==="}"){r.push({type:"CLOSE",index:t,value:e[t++]});continue}if(i===":"){for(var s="",a=t+1;a<e.length;){var n=e.charCodeAt(a);if(n>=48&&n<=57||n>=65&&n<=90||n>=97&&n<=122||n===95){s+=e[a++];continue}break}if(!s)throw new TypeError("Missing parameter name at ".concat(t));r.push({type:"NAME",index:t,value:s}),t=a;continue}if(i==="("){var c=1,l="",a=t+1;if(e[a]==="?")throw new TypeError('Pattern cannot start with "?" at '.concat(a));for(;a<e.length;){if(e[a]==="\\"){l+=e[a++]+e[a++];continue}if(e[a]===")"){if(c--,c===0){a++;break}}else if(e[a]==="("&&(c++,e[a+1]!=="?"))throw new TypeError("Capturing groups are not allowed at ".concat(a));l+=e[a++]}if(c)throw new TypeError("Unbalanced pattern at ".concat(t));if(!l)throw new TypeError("Missing pattern at ".concat(t));r.push({type:"PATTERN",index:t,value:l}),t=a;continue}r.push({type:"CHAR",index:t,value:e[t++]})}return r.push({type:"END",index:t,value:""}),r}function D(e,r){r===void 0&&(r={});for(var t=pe(e),i=r.prefixes,s=i===void 0?"./":i,a=r.delimiter,n=a===void 0?"/#?":a,c=[],l=0,f=0,u="",o=function(w){if(f<t.length&&t[f].type===w)return t[f++].value},d=function(w){var m=o(w);if(m!==void 0)return m;var P=t[f],C=P.type,Z=P.index;throw new TypeError("Unexpected ".concat(C," at ").concat(Z,", expected ").concat(w))},v=function(){for(var w="",m;m=o("CHAR")||o("ESCAPED_CHAR");)w+=m;return w},b=function(w){for(var m=0,P=n;m<P.length;m++){var C=P[m];if(w.indexOf(C)>-1)return!0}return!1},T=function(w){var m=c[c.length-1],P=w||(m&&typeof m=="string"?m:"");if(m&&!P)throw new TypeError('Must have text between two parameters, missing text after "'.concat(m.name,'"'));return!P||b(P)?"[^".concat($(n),"]+?"):"(?:(?!".concat($(P),")[^").concat($(n),"])+?")};f<t.length;){var y=o("CHAR"),g=o("NAME"),F=o("PATTERN");if(g||F){var S=y||"";s.indexOf(S)===-1&&(u+=S,S=""),u&&(c.push(u),u=""),c.push({name:g||l++,prefix:S,suffix:"",pattern:F||T(S),modifier:o("MODIFIER")||""});continue}var p=y||o("ESCAPED_CHAR");if(p){u+=p;continue}u&&(c.push(u),u="");var j=o("OPEN");if(j){var S=v(),M=o("NAME")||"",h=o("PATTERN")||"",A=v();d("CLOSE"),c.push({name:M||(h?l++:""),pattern:M&&!h?T(S):h,prefix:S,suffix:A,modifier:o("MODIFIER")||""});continue}d("END")}return c}x.parse=D;function de(e,r){return z(D(e,r),r)}x.compile=de;function z(e,r){r===void 0&&(r={});var t=J(r),i=r.encode,s=i===void 0?function(l){return l}:i,a=r.validate,n=a===void 0?!0:a,c=e.map(function(l){if(typeof l=="object")return new RegExp("^(?:".concat(l.pattern,")$"),t)});return function(l){for(var f="",u=0;u<e.length;u++){var o=e[u];if(typeof o=="string"){f+=o;continue}var d=l?l[o.name]:void 0,v=o.modifier==="?"||o.modifier==="*",b=o.modifier==="*"||o.modifier==="+";if(Array.isArray(d)){if(!b)throw new TypeError('Expected "'.concat(o.name,'" to not repeat, but got an array'));if(d.length===0){if(v)continue;throw new TypeError('Expected "'.concat(o.name,'" to not be empty'))}for(var T=0;T<d.length;T++){var y=s(d[T],o);if(n&&!c[u].test(y))throw new TypeError('Expected all "'.concat(o.name,'" to match "').concat(o.pattern,'", but got "').concat(y,'"'));f+=o.prefix+y+o.suffix}continue}if(typeof d=="string"||typeof d=="number"){var y=s(String(d),o);if(n&&!c[u].test(y))throw new TypeError('Expected "'.concat(o.name,'" to match "').concat(o.pattern,'", but got "').concat(y,'"'));f+=o.prefix+y+o.suffix;continue}if(!v){var g=b?"an array":"a string";throw new TypeError('Expected "'.concat(o.name,'" to be ').concat(g))}}return f}}x.tokensToFunction=z;function me(e,r){var t=[],i=_(e,t,r);return K(i,t,r)}x.match=me;function K(e,r,t){t===void 0&&(t={});var i=t.decode,s=i===void 0?function(a){return a}:i;return function(a){var n=e.exec(a);if(!n)return!1;for(var c=n[0],l=n.index,f=Object.create(null),u=function(d){if(n[d]===void 0)return"continue";var v=r[d-1];v.modifier==="*"||v.modifier==="+"?f[v.name]=n[d].split(v.prefix+v.suffix).map(function(b){return s(b,v)}):f[v.name]=s(n[d],v)},o=1;o<n.length;o++)u(o);return{path:c,index:l,params:f}}}x.regexpToFunction=K;function $(e){return e.replace(/([.+*?=^!:${}()[\]|/\\])/g,"\\$1")}function J(e){return e&&e.sensitive?"":"i"}function ve(e,r){if(!r)return e;for(var t=/\((?:\?<(.*?)>)?(?!\?)/g,i=0,s=t.exec(e.source);s;)r.push({name:s[1]||i++,prefix:"",suffix:"",modifier:"",pattern:""}),s=t.exec(e.source);return e}function he(e,r,t){var i=e.map(function(s){return _(s,r,t).source});return new RegExp("(?:".concat(i.join("|"),")"),J(t))}function ye(e,r,t){return V(D(e,t),r,t)}function V(e,r,t){t===void 0&&(t={});for(var i=t.strict,s=i===void 0?!1:i,a=t.start,n=a===void 0?!0:a,c=t.end,l=c===void 0?!0:c,f=t.encode,u=f===void 0?function(m){return m}:f,o=t.delimiter,d=o===void 0?"/#?":o,v=t.endsWith,b=v===void 0?"":v,T="[".concat($(b),"]|$"),y="[".concat($(d),"]"),g=n?"^":"",F=0,S=e;F<S.length;F++){var p=S[F];if(typeof p=="string")g+=$(u(p));else{var j=$(u(p.prefix)),M=$(u(p.suffix));if(p.pattern)if(r&&r.push(p),j||M)if(p.modifier==="+"||p.modifier==="*"){var h=p.modifier==="*"?"?":"";g+="(?:".concat(j,"((?:").concat(p.pattern,")(?:").concat(M).concat(j,"(?:").concat(p.pattern,"))*)").concat(M,")").concat(h)}else g+="(?:".concat(j,"(").concat(p.pattern,")").concat(M,")").concat(p.modifier);else{if(p.modifier==="+"||p.modifier==="*")throw new TypeError('Can not repeat "'.concat(p.name,'" without a prefix and suffix'));g+="(".concat(p.pattern,")").concat(p.modifier)}else g+="(?:".concat(j).concat(M,")").concat(p.modifier)}}if(l)s||(g+="".concat(y,"?")),g+=t.endsWith?"(?=".concat(T,")"):"$";else{var A=e[e.length-1],w=typeof A=="string"?y.indexOf(A[A.length-1])>-1:A===void 0;s||(g+="(?:".concat(y,"(?=").concat(T,"))?")),w||(g+="(?=".concat(y,"|").concat(T,")"))}return new RegExp(g,J(t))}x.tokensToRegexp=V;function _(e,r,t){return e instanceof RegExp?ve(e,r):Array.isArray(e)?he(e,r,t):ye(e,r,t)}x.pathToRegexp=_});import H from"react";var N=e=>JSON.stringify(e??null).replaceAll("&","\\u0026").replaceAll("<","\\u003c").replaceAll(">","\\u003e").replaceAll('"',"\\u0022").replaceAll("'","\\u0027"),R=e=>e.replaceAll("&","\\u0026").replaceAll("<","\\u003c").replaceAll(">","\\u003e");var se=({islandKey:e,hydrate:r="visible",props:t,children:i,resolveIslandModule:s})=>{if(typeof s!="function")throw new Error("Island requires resolveIslandModule(islandKey) to be provided.");let a=s(e);if(!a)return H.createElement(H.Fragment,null,i||null);let n=N(t);return H.createElement("div",{"data-island-module":a,"data-hydrate":r,"data-props":n,suppressHydrationWarning:!0},i||null)};import ce from"node:fs";import{createHash as le}from"node:crypto";var O=({mode:e,devModules:r,manifestPath:t,runtimeDevSrc:i="/assets/islands-runtime.js",includeIntegrity:s=!0,extraManifestFields:a={}})=>{let n=u=>{let o=R(JSON.stringify(u)),d=null;return s&&(d=`sha256-${le("sha256").update(o).digest("base64")}`),{manifest:u,manifestJson:o,manifestIntegrity:d}};if(e==="dev"){let u={modules:r||{},"islands-runtime":i,...a},o=n(u);return{mode:"dev",getManifest:()=>o.manifest,getManifestJson:()=>o.manifestJson,getManifestIntegrity:()=>o.manifestIntegrity}}if(!t)throw new Error("createManifestProvider: manifestPath is required in prod mode");let c=ce.readFileSync(t,"utf8"),l={...JSON.parse(c),...a};if(!l.modules)throw new Error("Manifest missing required key: modules");let f=n(l);return{mode:"prod",getManifest:()=>f.manifest,getManifestJson:()=>f.manifestJson,getManifestIntegrity:()=>f.manifestIntegrity}};var fe=({devOrigin:e,allowInlineScriptsInDev:r=!0}={})=>(t,i,s)=>{let a=process.env.NODE_ENV!=="production",n=e||(a?process.env.ASSETS_ORIGIN||"http://localhost:5173":""),c=n?n.replace(/^http/,"ws"):"",l=["default-src 'self'","base-uri 'self'","object-src 'none'","frame-ancestors 'none'",`script-src 'self'${a&&n?` ${n}${r?" 'unsafe-inline'":""}`:""}`,"style-src 'self' 'unsafe-inline'","img-src 'self' data: https:","font-src 'self' data:",`connect-src 'self' https:${a&&n?` ${n}${c?` ${c}`:""}`:""}`,"manifest-src 'self'","worker-src 'self'"];i.setHeader("Content-Security-Policy",l.join("; ")),i.setHeader("X-Content-Type-Options","nosniff"),i.setHeader("Referrer-Policy","no-referrer"),i.setHeader("X-Frame-Options","DENY"),s()},ue=({logger:e=console.warn,onEvent:r})=>(t,i)=>{let{event:s,detail:a,path:n,timestamp:c}=t.body||{};if(!s||typeof s!="string"){i.status(400).json({ok:!1});return}let l={event:s,detail:a||{},path:n||t.path,timestamp:c||new Date().toISOString(),ip:t.ip,userAgent:t.get&&t.get("user-agent")||""};try{e("client-security-event",l)}catch{}if(typeof r=="function")try{r(l)}catch{}i.status(204).end()};var X=oe(B(),1);import{readdir as ge}from"node:fs/promises";import I from"node:path";import{pathToFileURL as xe,fileURLToPath as we}from"node:url";var Ee=e=>e.endsWith(".route.jsx")||e.endsWith(".route.js"),q=async e=>{let r=await ge(e,{withFileTypes:!0}),t=[];for(let i of r){let s=I.join(e,i.name);if(i.isDirectory()){t.push(...await q(s));continue}i.isFile()&&Ee(i.name)&&t.push(s)}return t},Te=(e,r)=>{let s="/"+I.relative(e,r).replaceAll(I.sep,"/").replace(/\.route\.(jsx|js)$/i,"").split("/").map(a=>{if(a==="index"||a==="_layout")return"";let n=a.match(/^\[(.+)\]$/);return n?`:${n[1]}`:a}).filter(Boolean).join("/");return s===""&&(s="/"),s},Ae=(e,r)=>{let t=I.relative(e,I.dirname(r)).replaceAll(I.sep,"/");return!t||t==="."?[]:t.split("/").filter(Boolean)},Se=async({routesDir:e})=>{let r=we(e),t=await q(r),i=new Map,s=[];for(let n of t){let l=await import(xe(n).href),f=I.basename(n),u=Ae(r,n).join("/");if(f.startsWith("_layout.route.")){if(!l.Layout)throw new Error(`Layout module missing export "Layout": ${n}`);i.set(u,l);continue}if(!l.Page)throw new Error(`Route module missing export "Page": ${n}`);let o=Te(r,n);s.push({pattern:o,module:l,fileAbs:n,folderKey:u})}let a=s.map(n=>{let c=n.folderKey?n.folderKey.split("/"):[],l=[];i.has("")&&l.push(i.get(""));for(let f=0;f<c.length;f++){let u=c.slice(0,f+1).join("/");i.has(u)&&l.push(i.get(u))}return{pattern:n.pattern,page:n.module,layouts:l,matcher:(0,X.match)(n.pattern,{decode:decodeURIComponent})}});return a.sort((n,c)=>c.pattern.length-n.pattern.length),{match:n=>{for(let c of a){let l=c.matcher(n);if(l)return{params:l.params,page:c.page,layouts:c.layouts,pattern:c.pattern}}return null},routes:a.map(n=>n.pattern)}};import W from"react";import{renderToPipeableStream as be}from"react-dom/server";var je=e=>{let r={title:null,meta:[],links:[]};for(let t of e)t&&(t.title&&(r.title=t.title),Array.isArray(t.meta)&&r.meta.push(...t.meta),Array.isArray(t.links)&&r.links.push(...t.links));return r},Me=({HtmlDocument:e,resolveIslandModule:r,getAllIslandModuleSpecifiers:t,devOrigin:i="http://localhost:5173",manifestPath:s="dist/client/islands-manifest.json"})=>{let a=()=>{if(process.env.NODE_ENV==="production")return O({mode:"prod",manifestPath:s});let c=t(),l={};for(let f of c)l[f]=`${i}${f}`;return O({mode:"dev",devModules:l,runtimeDevSrc:`${i}/src/client/islands-runtime.entry.js`,extraManifestFields:{"pwa-toast":`${i}/src/client/pwa-toast.entry.js`}})};return async({req:n,res:c,router:l})=>{let f=l.match(n.path);if(!f){c.status(404).send("Not Found");return}let u={req:n,params:f.params},o={},d=[];for(let h of f.layouts){if(h.loader){let A=await h.loader(u);A&&typeof A=="object"&&(o={...o,...A})}h.head&&d.push(await h.head(o,u))}if(f.page.loader){let h=await f.page.loader(u);h&&typeof h=="object"&&(o={...o,...h})}f.page.head&&d.push(await f.page.head(o,u));let v=je(d),b=a(),T=b.getManifest(),y=R(JSON.stringify(T)),g=b.getManifestIntegrity?b.getManifestIntegrity():null,F=T["islands-runtime"]||"/assets/islands-runtime.js",S=T["pwa-toast"]||null,p=W.createElement(f.page.Page,o);for(let h=f.layouts.length-1;h>=0;h--){let A=f.layouts[h].Layout;p=W.createElement(A,o,p)}let j=!1,M=W.createElement(e,{head:v,manifestJson:y,manifestIntegrity:g,runtimeSrc:F,pwaToastSrc:S,resolveIslandModule:r},p);await new Promise((h,A)=>{let{pipe:w}=be(M,{onShellReady(){c.statusCode=j?500:200,c.setHeader("Content-Type","text/html; charset=utf-8"),c.setHeader("X-Content-Type-Options","nosniff"),w(c)},onShellError(m){A(m)},onError(m){j=!0,console.error(m)}});c.on("close",h)})}};import E from"react";var Pe=({head:e,children:r,manifestJson:t,manifestIntegrity:i,runtimeSrc:s,pwaToastSrc:a,preloadHrefs:n=[]})=>{let c=e?.title||"React Islands",l=e?.meta||[],f=e?.links||[];return E.createElement("html",{lang:"en"},E.createElement("head",null,E.createElement("meta",{charSet:"utf-8"}),E.createElement("meta",{name:"viewport",content:"width=device-width, initial-scale=1"}),E.createElement("title",null,c),l.map((u,o)=>E.createElement("meta",{key:o,...u})),f.map((u,o)=>E.createElement("link",{key:o,...u})),n.map(u=>E.createElement("link",{key:u,rel:"modulepreload",href:u})),E.createElement("link",{rel:"manifest",href:"/manifest.webmanifest"}),E.createElement("link",{rel:"icon",href:"/icons/islands.jpg",type:"image/jpeg"}),E.createElement("script",{id:"islands-manifest",type:"application/json","data-integrity":i||void 0,dangerouslySetInnerHTML:{__html:t}}),E.createElement("script",{type:"module",src:s}),a?E.createElement("script",{type:"module",src:a}):null),E.createElement("body",null,E.createElement("div",{id:"app"},r)))};import L from"node:fs";import G from"node:path";var Fe=e=>JSON.parse(L.readFileSync(e,"utf8")),$e=e=>{if(e.startsWith("src/client/islands/")&&e.includes(".entry.")){let r=e.replace(/^src\/client\/islands\//,"").replace(/\.entry\.(js|jsx)$/,""),t=e.endsWith(".js")?".js":".jsx";return`/src/client/islands/${r}.entry${t}`}return null},Y=({viteManifestPath:e,outPath:r})=>{if(!L.existsSync(e))throw new Error(`Vite manifest not found: ${e}`);let t=Fe(e),i={};for(let[c,l]of Object.entries(t)){let f=$e(c);f&&(i[f]=`/${l.file}`)}let s=null,a=null;for(let[c,l]of Object.entries(t))c==="src/client/islands-runtime.entry.js"&&(s=`/${l.file}`),c==="src/client/pwa-toast.entry.js"&&(a=`/${l.file}`);if(!s)throw new Error("Could not find runtime entry src/client/islands-runtime.entry.js in Vite manifest");let n={modules:i,"islands-runtime":s,"pwa-toast":a};return L.writeFileSync(r,JSON.stringify(n,null,"	"),"utf8"),n},Q=()=>{let e=process.argv.slice(2),r=n=>{let c=e.indexOf(n);return c===-1?null:e[c+1]},t=r("--in"),i=r("--out")||"dist/client/islands-manifest.json";if(!t)throw new Error("Usage: react-islands-gen-manifest --in dist/client/.vite/manifest.json [--out dist/client/islands-manifest.json]");let s=G.resolve(t),a=G.resolve(i);Y({viteManifestPath:s,outPath:a}),console.log(`Wrote ${a}`)};import.meta.url===`file://${process.argv[1]}`&&Q();export{Pe as HtmlDocument,se as Island,Y as buildIslandsManifest,Se as createFileRouter,O as createManifestProvider,Me as createRenderRequest,ue as createSecurityEventHandler,fe as cspMiddleware,R as escapeJsonForInlineScript,Q as runManifestCli,N as serializePropsForAttr};
//# sourceMappingURL=index.js.map
